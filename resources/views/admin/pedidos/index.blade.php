@extends('adminlte::page')

@section('content_header')
<h1><b>Listado de pedidos</b></h1>

{{-- SELECTOR DE FECHA GLOBAL --}}
<form method="GET" class="mt-3 mb-3 d-flex align-items-center" style="gap: 10px;">
    <label for="fecha"><b>Fecha:</b></label>
    <input type="date"
           name="fecha"
           id="fecha"
           class="form-control"
           style="width: 200px"
           value="{{ request('fecha', now()->format('Y-m-d')) }}">
    <button class="btn btn-primary btn-sm" type="submit">Filtrar</button>
</form>

<hr>
@stop

@section('content')

<meta name="csrf-token" content="{{ csrf_token() }}">

<div class="container-fluid">


             {{-- ============================= --}}
            {{-- MAPA GENERAL DE PEDIDOS --}}
            {{-- ============================= --}}
            <div class="card card-outline card-secondary mt-3">
                <div class="card-header">
                    <h3 class="card-title">
                        üó∫Ô∏è Mapa general de pedidos registrados
                    </h3>
                </div>

                <div class="card-body p-0">
                    <div id="mapa-general-pedidos"
                        style="height:280px; width:100%; background:#eee;">
                    </div>
                </div>
            </div>


            <div class="card card-outline card-info mb-3">
                <div class="card-body">

                    <div class="row align-items-end">

                        {{-- BUSCADOR CLIENTE --}}
                        <div class="col-md-4">
                            <label>Cliente</label>
                            <input type="text" id="buscadorCliente" class="form-control" placeholder="Buscar cliente...">
                            <div id="resultadosClientes" class="list-group mt-1"></div>
                        </div>

                        {{-- MOTOQUERO --}}
                        <div class="col-md-3">
                            <label>Distribuidor</label>
                            <select id="motoqueroSelect" class="form-control">
                                <option value="">Seleccionar</option>
                                @foreach($motoqueros as $m)
                                    <option value="{{ $m->id }}">{{ $m->apellidos }} {{ $m->nombres }}</option>
                                @endforeach
                            </select>
                        </div>

                        {{-- RUTA --}}
                        <div class="col-md-2">
                            <label>Ruta</label>
                            <select id="rutaSelect" class="form-control">
                                <option value="">Ruta</option>
                                <option>A</option>
                                <option>B</option>
                                <option>C</option>
                                <option>D</option>
                            </select>
                        </div>

                        {{-- BOT√ìN --}}
                        <div class="col-md-3">
                            <button id="btnCrearPedidoRapido" class="btn btn-success w-100">
                                ‚ûï Crear Pedido Rapido
                            </button>
                        </div>

                    </div>
                </div>
            </div>



<div class="row">


    {{-- ======================================================= --}}
    {{-- COLUMNA IZQUIERDA ‚Üí LISTA DE WHATSAPP (NUEVA SECCI√ìN AGREGADA) --}}
    {{-- ======================================================= --}}
    {{-- NUEVO: Se crea una columna de 3 para mostrar los contactos de WhatsApp --}}
    <div class="col-md-2">

        {{-- NUEVO: TARJETA DE CONTACTOS WHATSAPP --}}
        <div class="card card-outline card-success">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fab fa-whatsapp"></i> Contactos que escribieron hoy
                </h3>
            </div>

            <div class="card-body" style="max-height: 450px; overflow-y: auto;">
                
                {{-- NUEVO: Aqu√≠ mostramos los contactos del d√≠a --}}
                @if($contactosHoy->isEmpty())
                    <p class="text-muted text-center">Nadie escribi√≥ hoy</p>
                @else
                    @foreach($contactosHoy as $c)

                    @php
                        $clienteWhatsapp = \App\Models\Cliente::where('celular', $c->from)
                            ->orWhere('nombre', $c->name)
                            ->first();

                        $latitud  = $clienteWhatsapp->latitud ?? null;
                        $longitud = $clienteWhatsapp->longitud ?? null;

                        $pedidoExistente = \App\Models\Pedido::whereHas('cliente', function($q) use ($c) {
                            $q->where('celular', $c->from)
                            ->orWhere('nombre', $c->name);
                        })->whereDate('created_at', now()->format('Y-m-d'))->exists();
                    @endphp

                    <div
                    class="border rounded p-2 mb-2 whatsapp-contact"
                    style="background:#e9ffe9; font-size:0.8rem;"
                    data-lat="{{ $latitud }}"
                    data-lng="{{ $longitud }}"
                    >

                        {{-- INFO CLIENTE --}}
                        <div class="mb-1">
                            <b>{{ $c->name }}</b><br>
                            <small>{{ $c->from }}</small>
                        </div>

                        {{-- SELECTOR MOTOQUERO --}}
                        <select class="form-control form-control-sm mb-1 selector-motoquero">
                            <option value="">Distribuidor</option>
                            @foreach($motoqueros as $m)
                                <option value="{{ $m->id }}">
                                    {{ $m->apellidos }} {{ $m->nombres }}
                                </option>
                            @endforeach
                        </select>

                        {{-- SELECTOR RUTA --}}
                        <select class="form-control form-control-sm mb-1 selector-ruta">
                            <option value="">Ruta</option>
                            <option value="A">Ruta A</option>
                            <option value="B">Ruta B</option>
                            <option value="C">Ruta C</option>
                            <option value="D">Ruta D</option>
                        </select>

                        {{-- BOT√ìN REGISTRAR --}}
                        <button
                            class="btn btn-sm w-100 {{ $pedidoExistente ? 'btn-secondary' : 'btn-success' }} btn-registrar-pedido"
                            data-nombre="{{ $c->name }}"
                            data-celular="{{ $c->from }}"
                            {{ $pedidoExistente ? 'disabled' : '' }}
                        >
                            {{ $pedidoExistente ? 'Pedido registrado' : 'Registrar pedido' }}
                        </button>
                    </div>


                    @endforeach
                @endif

            </div>
        </div>

    </div> {{-- FIN COLUMNA IZQUIERDA --}}


        {{-- ===================================== --}}
        {{-- ========== TABLA GENERAL ============ --}}
        {{-- ===================================== --}}
    <div class="col-md-10">

    

        <div class="card card-outline card-primary">


            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="card-title mb-0">Pedidos registrados</h3>
                    <small class="text-muted">
                        Mostrando {{ $pedidos->count() }} pedidos
                    </small>
                </div>

                <a href="{{ url('/admin/pedidos/create') }}" class="btn btn-primary">
                    ‚ûï Crear Varios Pedidos
                </a>
            </div>




            <div class="card-body">

                <div class="tabla-scroll">

                    <table id="example1" class="table table-bordered table-hover table-striped table-sm">
                        <thead>
                            <tr>
                                <th style="text-align:center">Nro</th>
                                <th style="text-align:center">Cliente</th>
                                <th style="text-align:center">Promo</th>
                                <th style="text-align:center">Celular</th>
                                <th style="text-align:center">Descripci√≥n</th>
                                <th style="text-align:center">Ubicaci√≥n GPS</th>
                                <th style="text-align:center">Latitud</th>
                                <th style="text-align:center">Longitud</th>
                                <th style="text-align:center">Precios</th>
                                <th style="text-align:center">Distribuidor</th>
                                <th style="text-align:center">Estado</th>
                                <th style="text-align:center">Acci√≥n</th>
                            </tr>
                        </thead>

                        <tbody>
                        @php
                            $pedidosOrdenados = $pedidos->sortByDesc('updated_at')->values();
                            $total = $pedidosOrdenados->count();
                        @endphp

                        @foreach($pedidosOrdenados as $index => $pedido)
                            <tr>

                                <td style="text-align:center">{{ $total - $index }}</td>

                                <td>{{ $pedido->cliente->nombre ?? '‚Äî' }}</td>

                                <td style="text-align:center">
                                    @if($pedido->cliente && $pedido->cliente->promo_activa)
                                        <span class="badge bg-success">Tiene</span>
                                    @else
                                        <span class="text-muted">No</span>
                                    @endif
                                </td>

                                <td>{{ $pedido->cliente->celular ?? '‚Äî' }}</td>
                                <td>{{ $pedido->cliente->direccion ?? $pedido->direccion_entrega ?? '‚Äî' }}</td>

                                <td>
                                    @if(!empty($pedido->cliente->ubicacion_gps))
                                        <a href="{{ $pedido->cliente->ubicacion_gps }}" target="_blank">Ver enlace</a>
                                    @else
                                        <span class="text-muted">No registrado</span>
                                    @endif
                                </td>

                                <td>{{ $pedido->cliente->latitud ?? '-' }}</td>
                                <td>{{ $pedido->cliente->longitud ?? '-' }}</td>


                                <td>
                                    @if($pedido->precio_regular_ref)
                                        <small>
                                            <strong>Reg:</strong> Bs {{ number_format($pedido->precio_regular_ref, 2) }}<br>
                                            <strong>Alc:</strong> Bs {{ number_format($pedido->precio_alcalina_ref, 2) }}
                                        </small>
                                    @else
                                        -
                                    @endif
                                </td>


                                <td style="text-align:center">
                                    @if($pedido->motoquero)
                                        {{ $pedido->motoquero->nombres }} {{ $pedido->motoquero->apellidos }}
                                        <small class="text-muted">
                                            ({{ $pedido->ruta ?? '-' }})
                                        </small>
                                    @else
                                        <span class="text-muted">Sin asignar</span>
                                    @endif
                                </td>

                                <td style="text-align:center">
                                    @switch($pedido->estado)
                                        @case('Pendiente')
                                            <span class="badge bg-secondary">Pendiente</span>
                                            @break
                                        @case('Por asignar')
                                            <span class="badge bg-warning text-dark">Por asignar</span>
                                            @break
                                        @case('Asignado')
                                            <span class="badge bg-primary">Asignado</span>
                                            @break
                                        @case('En camino')
                                            <span class="badge bg-orange">En camino</span>
                                            @break
                                        @case('Entregado')
                                            <span class="badge bg-success">Entregado</span>
                                            @break
                                    @endswitch
                                </td>

                                {{-- ACCI√ìN --}}
                                <td style="text-align:center">

                                    <div class="d-flex justify-content-center gap-2">

                                        <!-- BOT√ìN EDITAR -->
                                        <button
                                            class="btn btn-sm btn-outline-primary btn-editar-pedido"
                                            data-bs-toggle="modal"
                                            data-bs-target="#modalEditarPedido"
                                            data-pedido-id="{{ $pedido->id }}"
                                        >
                                            <i class="fas fa-edit"></i>
                                        </button>

                                        <!-- BOT√ìN ELIMINAR -->
                                        @if($pedido->estado !== 'Entregado')
                                            <form
                                                action="{{ url('/admin/pedidos/'.$pedido->id) }}"
                                                method="post"
                                                id="formEliminar{{ $pedido->id }}"
                                                onsubmit="confirmEliminar{{ $pedido->id }}(event)"
                                            >
                                                @csrf
                                                @method('DELETE')

                                                <button type="submit" class="btn btn-sm btn-danger">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        @else
                                            <span class="text-muted">‚Äî</span>
                                        @endif

                                    </div>

                                    <!-- SWEETALERT -->
                                    <script>
                                        function confirmEliminar{{ $pedido->id }}(e) {
                                            e.preventDefault();

                                            Swal.fire({
                                                title: '¬øEliminar pedido?',
                                                text: 'Esta acci√≥n no se puede deshacer',
                                                icon: 'warning',
                                                showCancelButton: true,
                                                confirmButtonColor: '#d33',
                                                confirmButtonText: 'Eliminar',
                                                cancelButtonText: 'Cancelar'
                                            }).then((result) => {
                                                if (result.isConfirmed) {
                                                    document.getElementById('formEliminar{{ $pedido->id }}').submit();
                                                }
                                            });
                                        }
                                    </script>

                                </td>

                            </tr>
                        @endforeach
                        </tbody>
                    </table>

                </div>

            </div>



        </div>
    </div>
</div>    

        {{-- ===================================== --}}
        {{-- ========== PANEL MOTOQUEROS ========= --}}
        {{-- ===================================== --}}
        <hr>
        <h3 class="text-center mt-4 mb-4"><b>Panel de control por Distribuidor</b></h3>

    <div class="row">
            @foreach($motoqueros as $motoquero)
            <div class="col-md-3 mb-4" id="panel-motoquero-{{ $motoquero->id }}">
                <div class="motoquero-card">
                    <h4 class="text-center"><b>#{{ $motoquero->id }}, {{ $motoquero->apellidos }} {{ $motoquero->nombres }}</b></h4>
                    <hr>


                    {{-- ================== --}}
                    {{-- MINI TABLA DESPACHO --}}
                    {{-- ================== --}}

                    @php
                        $despacho = $despachosHoy[$motoquero->id] ?? null;

                        $regularDespachado = $despacho->botellones_regular ?? 0;
                        $alcalinaDespachado = $despacho->botellones_alcalina ?? 0;

                        $vendidosRegular = $pedidos
                            ->where('estado','Entregado')
                            ->where('motoquero_id',$motoquero->id)
                            ->sum(function($p){
                                return $p->detalles->where('producto','Agua Regular')->sum('cantidad');
                            });

                        $vendidosAlcalina = $pedidos
                            ->where('estado','Entregado')
                            ->where('motoquero_id',$motoquero->id)
                            ->sum(function($p){
                                return $p->detalles->where('producto','Agua Alcalina')->sum('cantidad');
                            });

                        $restanteRegular = $regularDespachado - $vendidosRegular;
                        $restanteAlcalina = $alcalinaDespachado - $vendidosAlcalina;
                    @endphp

                    <div class="table-responsive mb-3">
                        <table class="table table-sm table-bordered text-center" style="font-size:12px;">
                            <thead class="table-light">
                                <tr>
                                    <th></th>
                                    <th>Regular</th>
                                    <th>Alcalina</th>
                                </tr>
                            </thead>
                            <tbody>

                                {{-- FILA 1 - DESPACHO --}}
                                <tr>
                                    <td><b>Despacho</b></td>
                                    <td>
                                        <form action="{{ route('admin.despachos.store') }}" method="POST">
                                            @csrf
                                            <input type="hidden" name="motoquero_id" value="{{ $motoquero->id }}">
                                            <input type="number" name="botellones_regular"
                                                value="{{ $regularDespachado }}"
                                                class="form-control form-control-sm text-center"
                                                style="font-size:11px; padding:2px;">
                                    </td>
                                    <td>
                                            <input type="number" name="botellones_alcalina"
                                                value="{{ $alcalinaDespachado }}"
                                                class="form-control form-control-sm text-center"
                                                style="font-size:11px; padding:2px;">

                                            <input type="hidden" name="dispensers" value="0">

                                            <button type="submit"
                                                class="btn btn-success btn-sm mt-1 w-100"
                                                style="font-size:10px; padding:2px;">
                                                Guardar
                                            </button>
                                        </form>
                                    </td>
                                </tr>

                                {{-- FILA 2 - VENDIDO --}}
                                <tr class="table-warning">
                                    <td><b>Vendido</b></td>
                                    <td>{{ $vendidosRegular }}</td>
                                    <td>{{ $vendidosAlcalina }}</td>
                                </tr>

                                {{-- FILA 3 - RESTANTE --}}
                                <tr class="table-success">
                                    <td><b>Restante</b></td>
                                    <td>{{ $restanteRegular }}</td>
                                    <td>{{ $restanteAlcalina }}</td>
                                </tr>

                            </tbody>
                        </table>
                    </div>



                    {{-- BOT√ìN REPORTE --}}
                    <div class="text-center mb-2">
                        <button class="btn btn-dark btn-sm abrirReporte" data-motoquero="{{ $motoquero->id }}">
                            Reporte de ventas
                        </button>

                        
                        
                    </div>


            {{-- ===================================== --}}
            {{-- POR ASIGNAR ‚Äì RUTAS A B C D (VISUAL) --}}
            {{-- ===================================== --}}
            <div class="estado-section">

                <div class="estado-title asignar">üü® Por asignar</div>


                    {{-- MAPA POR ASIGNAR --}}
                    <div
                        class="mapa-por-asignar mt-2 mb-2"
                        id="mapa-por-asignar-{{ $motoquero->id }}"
                        data-motoquero="{{ $motoquero->id }}"
                        data-ruta="A"
                        style="height:280px; border-radius:8px; background:#eee;">
                    </div>


                    <div class="d-flex justify-content-between gap-2 mb-2">
                        <button
                            class="btn btn-sm btn-outline-primary btn-ordenar-mapa"
                            data-motoquero="{{ $motoquero->id }}">
                            üìç Ordenar en mapa
                        </button>

                        <button
                            class="btn btn-sm btn-success btn-guardar-orden-mapa"
                            data-motoquero="{{ $motoquero->id }}"
                            disabled>
                            üíæ Guardar orden
                        </button>
                    </div>


                {{-- SELECTOR DE RUTA --}}
                <div class="ruta-selector mt-2">
                    <button class="btn btn-sm btn-outline-primary btn-ruta active" data-ruta="A">A</button>
                    <button class="btn btn-sm btn-outline-primary btn-ruta" data-ruta="B">B</button>
                    <button class="btn btn-sm btn-outline-primary btn-ruta" data-ruta="C">C</button>
                    <button class="btn btn-sm btn-outline-primary btn-ruta" data-ruta="D">D</button>
                </div>

                {{-- CONTENEDOR DE RUTAS --}}
                <div class="rutas-container mt-2">

                    @foreach(['A','B','C','D'] as $ruta)

                        @php
                            $porAsignarRuta = $pedidos
                                ->where('estado', 'Por asignar')
                                ->where('motoquero_id', $motoquero->id)
                                ->where('ruta', $ruta)
                                ->sortBy(function($it) {
                                    return $it->orden === null ? PHP_INT_MAX : $it->orden;
                                })
                                ->values();
                        @endphp

                        <div class="ruta ruta-{{ $ruta }} {{ $ruta === 'A' ? 'active' : '' }}" data-ruta="{{ $ruta }}">

                            @if($porAsignarRuta->count() > 0)
                                <button
                                    class="btn btn-primary btn-sm btn_asignar_todos mb-2"
                                    data-motoquero="{{ $motoquero->id }}"
                                    data-ruta="{{ $ruta }}"
                                >
                                    Asignar todos (Ruta {{ $ruta }})
                                </button>
                            @endif

                            <div
                                class="lista-por-asignar lista-ruta"
                                data-motoquero="{{ $motoquero->id }}"
                                data-ruta="{{ $ruta }}"
                            >
                                @if($porAsignarRuta->isEmpty())
                                    <div class="pedido-item text-muted">
                                        No hay pedidos en ruta {{ $ruta }}
                                    </div>
                                @else
                                    @foreach($porAsignarRuta as $p)
                                        <div class="pedido-item" data-id="{{ $p->id }}">
                                            <b>#{{ $p->orden }}</b> ‚Äì {{ $p->cliente->nombre }}

                                            <div>
                                                <small>
                                                    @if($p->cliente->ubicacion_gps)
                                                        <a href="{{ $p->cliente->ubicacion_gps }}" target="_blank">Ver enlace</a>
                                                    @else
                                                        <span class="text-muted">No registrado</span>
                                                    @endif
                                                </small>
                                            </div>
                                        </div>
                                    @endforeach
                                @endif
                            </div>

                        </div>

                    @endforeach

                </div>
            </div>

            {{-- ===================================== --}}
            {{-- ASIGNADO --}}
            {{-- ===================================== --}}
            <div class="estado-section">
                <div class="estado-title asignado">üü¶ Asignado</div>

                @php
                    $asignados = $pedidos
                        ->where('estado','Asignado')
                        ->where('motoquero_id',$motoquero->id)
                        ->sortBy(function($it) { return $it->orden === null ? PHP_INT_MAX : $it->orden; })
                        ->values();
                

                @endphp

                <div class="mt-2 lista-asignado" data-motoquero="{{ $motoquero->id }}">
                    @if($asignados->isEmpty())
                        <div class="pedido-item text-muted">No hay pedidos asignados.</div>
                    @else

                        @foreach($asignados as $p)
                            @php
                                $ultimaCompra = \App\Models\Pedido::with('detalles')
                                    ->where('cliente_id', $p->cliente_id)
                                    ->where('estado', 'Entregado')
                                    ->where('id', '!=', $p->id)
                                    ->orderBy('updated_at', 'desc')
                                    ->first();
                            @endphp

                            <div class="pedido-item pedido-card" data-id="{{ $p->id }}">

                                <b>#{{ $p->orden }}</b> - {{ $p->cliente->nombre }}

                                {{-- GPS --}}
                                <div>
                                    <small>
                                        @if($p->cliente->ubicacion_gps)
                                            <a href="{{ $p->cliente->ubicacion_gps }}" target="_blank">Ver enlace</a>
                                        @else
                                            <span class="text-muted">No registrado</span>
                                        @endif
                                    </small>
                                </div>

                                {{-- √öLTIMA COMPRA --}}
                                <div class="mt-1">
                                    <small><b>√öltima compra:</b></small>
                                    @if($ultimaCompra && $ultimaCompra->detalles->count() > 0)
                                        <ul class="mb-0 ps-3">
                                            @foreach($ultimaCompra->detalles as $d)
                                                <li>
                                                    <small>{{ $d->producto }} √ó {{ $d->cantidad }}</small>
                                                </li>
                                            @endforeach
                                        </ul>
                                    @else
                                        <small class="text-muted">Sin compras anteriores</small>
                                    @endif
                                </div>
                            </div>
                        @endforeach

                    @endif
                </div>
            </div>

            {{-- ===================================== --}}
            {{-- EN CAMINO --}}
            {{-- ===================================== --}}
            <div class="estado-section">
                <div class="estado-title camino">üüß En camino</div>

                @php
                    $enCamino = $pedidos
                        ->where('estado','En camino')
                        ->where('motoquero_id',$motoquero->id)
                        ->sortByDesc('updated_at')
                        ->values();
                @endphp

                <div class="mt-2 lista-en-camino" data-motoquero="{{ $motoquero->id }}">
                    @if($enCamino->isEmpty())
                        <div class="pedido-item text-muted">No hay pedidos en camino.</div>
                    @else
                        @foreach($enCamino as $index => $p)

                            <div class="pedido-item mb-3 p-3 border rounded" data-id="{{ $p->id }}">
                                
                                <b>{{ $p->cliente->nombre }}</b><br>

                                <div>
                                    <small>
                                        @if($p->cliente->ubicacion_gps)
                                            <a href="{{ $p->cliente->ubicacion_gps }}" target="_blank">Ver enlace</a>
                                        @else
                                            <span class="text-muted">No registrado</span>
                                        @endif
                                    </small>
                                </div>

                                @php
                                    $msgVoy = urlencode("Hola, su pedido ya est√° en camino a su ubicaci√≥n. El distribuidor llegar√° pronto.");
                                    $msgLlegada = urlencode("Hola, el distribuidor LLEG√ì a su ubicaci√≥n. Por favor ac√©rquese para recibir el pedido.");
                                @endphp


                                {{-- ================= ACCIONES ================= --}}
                                <div class="mt-3 p-2 border rounded bg-light">

                                    <div class="row g-2">

                                        {{-- COLUMNA CLIENTE --}}
                                        <div class="col-6">
                                            <div class="fw-bold small text-success mb-1">Cliente</div>

                                            <div class="d-grid gap-1">

                                                <a href="https://wa.me/{{ $p->cliente->celular }}?text={{ $msgVoy }}"
                                                target="_blank"
                                                class="btn btn-success btn-sm py-1"
                                                style="font-size: 12px;">
                                                    üöö En Camino
                                                </a>

                                                <a href="https://wa.me/{{ $p->cliente->celular }}?text={{ $msgLlegada }}"
                                                target="_blank"
                                                class="btn btn-warning btn-sm py-1"
                                                style="font-size: 12px;">
                                                    üìç Llegada
                                                </a>

                                            </div>
                                        </div>

                                        {{-- COLUMNA DISTRIBUIDOR --}}
                                        <div class="col-6">
                                            <div class="fw-bold small text-primary mb-1">Distribuidor</div>

                                            <div class="d-grid gap-1">

                                                <button 
                                                    class="btn btn-primary btn-sm py-1 btn-avisar"
                                                    style="font-size: 12px;"
                                                    data-id="{{ $p->id }}"
                                                    data-tipo="ya_sale">
                                                    üöÄ Ya Sale
                                                </button>

                                                <button 
                                                    class="btn btn-danger btn-sm py-1 btn-avisar"
                                                    style="font-size: 12px;"
                                                    data-id="{{ $p->id }}"
                                                    data-tipo="no_contesta">
                                                    üìû No Contesta
                                                </button>

                                            </div>
                                        </div>

                                    </div>

                                </div>

                            </div>

                        @endforeach
                    @endif
                </div>
            </div>


                    {{-- ENTREGADO --}}
                    <div class="estado-section entregado-scroll">
                        <div class="estado-title entregado">üü© Entregado</div>

                        @php
                            $entregados = $pedidos->where('estado','Entregado')->where('motoquero_id',$motoquero->id)->sortByDesc('updated_at');
                        @endphp

                        @if($entregados->isEmpty())
                            <div class="pedido-item text-muted">No hay pedidos entregados.</div>
                        @else
                            @foreach($entregados as $p)
                            <div class="pedido-item">
                                <b>{{ $p->cliente->nombre }}</b><br>
                                <small><b>Total:</b> Bs {{ number_format($p->total_precio ?? 0,2) }}</small><br>
                                <small><b>Pago:</b> {{ $p->metodo_pago ?? 'No definido' }}</small>
                            
                                {{-- BOTON - RECIBO --}}
                                @php
                                   $lineasProductos = "";

                                foreach ($p->detalles as $detalle) {
                                    $nombre = $detalle->producto;            // Nombre del producto
                                    $cantidad = $detalle->cantidad;          // Cantidad
                                    $precio = $detalle->precio_total;        // Precio total del detalle

                                    // Construimos cada l√≠nea del detalle
                                    $lineasProductos .= "‚Ä¢ $nombre ‚Äî Cant: $cantidad ‚Äî Bs $precio\n";
                                }

                                    $total = $p->total_precio;
                                    $metodo = ucfirst($p->metodo_pago);

                                    // Recibo base
                                    $mensajeBase =
                                        "Hola, gracias por su compra üôå\n\n".
                                        "üßæ *RECIBO DE COMPRA*\n\n".
                                    $lineasProductos . "\n".
                                        "üí∞ *TOTAL*: Bs $total\n".
                                        "üí≥ *M√©todo de pago*: $metodo\n\n".
                                        "¬°Gracias por confiar en nosotros!";

                                    // Si pag√≥ en efectivo ‚Üí mensaje normal
                                    if (strtolower($metodo) === 'efectivo') {
                                        $msgEntrega = urlencode($mensajeBase);
                                    }

                                    // Si pag√≥ con QR ‚Üí mensaje + l√≠nea + ‚Äú/‚Äù para abrir respuestas r√°pidas de WhatsApp Business
                                    else if (strtolower($metodo) === 'qr') {
                                        $mensajeQR = $mensajeBase . "\n\n/";
                                        $msgEntrega = urlencode($mensajeQR);
                                    }

                                    // Cualquier otro m√©todo, por si acaso
                                    else {
                                        $msgEntrega = urlencode($mensajeBase);
                                    }
                                @endphp

                                    <a href="https://wa.me/{{ $p->cliente->celular }}?text={{ $msgEntrega }}"
                                    target="_blank"
                                    class="btn btn-primary btn-sm mt-1 btn-recibo">
                                        <i class="fab fa-whatsapp"></i> Enviar Recibo
                                    </a>

                            </div>
                            @endforeach
                        @endif
                    </div>

                </div>
            </div>
            @endforeach
        </div>
    </div>
</div>



<form
    id="formPedidoWhatsapp"
    action="{{ route('admin.pedidos.store') }}"
    method="POST"
    style="display:none;"
>
    @csrf
    <input type="hidden" name="nombre" id="wp_nombre">
    <input type="hidden" name="celular" id="wp_celular">
    <input type="hidden" name="motoquero_id" id="wp_motoquero">
    <input type="hidden" name="ruta" id="wp_ruta">
    <input type="hidden" name="origen" value="whatsapp">
</form>


@stop

@section('css')
<style>
.motoquero-card { border:2px solid #007bff; border-radius:10px; padding:15px; background:#f8f9fa; }
.estado-section { border:2px dashed #ccc; border-radius:8px; padding:10px; margin-bottom:15px; }
.estado-section.entregado-scroll { max-height:300px; overflow-y:auto; }
.estado-title { font-weight:bold; padding:6px; border-radius:5px; text-align:center; }
.estado-title.asignar { background:#f0ad4e; color:#000; } 
.estado-title.asignado { background:#17a2b8; color:#fff; } 
.estado-title.camino { background:#fd7e14; color:#fff; } 
.estado-title.entregado { background:#28a745; color:#fff; }
.pedido-item { background:#fff; border:1px solid #dee2e6; padding:8px; border-radius:5px; margin-bottom:8px; cursor: grab; }
.pedido-item.dragging { opacity: 0.5; }
.badge.bg-orange { background: #fd7e14; color: #fff; }



.btn-emergencia-bar {width: 100%; border: none; background-color: #dc3545; color: #fff; font-size: 12px; padding: 6px 0; margin-bottom: 6px; border-radius: 4px; font-weight: bold; letter-spacing: 0.5px; cursor: pointer; }

/* Cuando ya est√° marcado */
.btn-emergencia-bar.emergencia-activa { background-color: #6c757d; /* gris */ cursor: not-allowed; }

/* Hover solo si NO est√° activo */
.btn-emergencia-bar:not(.emergencia-activa):hover { background-color: #b52a37; }


.ruta-selector { display: flex; gap: 6px; }

.ruta { display: none; }

.ruta.active { display: block; }

.lista-ruta { min-height: 80px; border: 1px dashed #ccc; padding: 6px; }


/* ===== SCROLL SOLO PARA TABLA ===== */
.tabla-scroll {
    max-height: 420px;      /* puedes ajustar: 350 / 400 / 500 */
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 6px;
}

/* Header de la tabla fijo */
.tabla-scroll thead th {
    position: sticky;
    top: 0;
    background: #f8f9fa;
    z-index: 2;
}

/* Footer de acciones fijo visualmente */
.sticky-footer-acciones {
    background: #fff;
    padding-top: 10px;
    border-top: 1px solid #ddd;
}


#mapa-general-pedidos {
    border-radius: 6px;
}

/* Oculta la X del InfoWindow */
.gm-ui-hover-effect {
    display: none !important;
}

</style>

@stop


@section('js')


<meta name="csrf-token" content="{{ csrf_token() }}">

<script
  src="https://maps.googleapis.com/maps/api/js?key={{ config('services.google_maps.key') }}&callback=initMaps"
  defer>
</script>



<script>
const mapas = {};
const marcadores = {};
const ordenMapa = {};
const polilineas = {};
let modoOrdenMapa = {};


let mapaGeneral = null;
let mapaGeneralListo = false;
let marcadoresGeneral = [];
let marcadorTemporal = null;
let marcadorDestacado = null;
let marcadorConfirmado = null;



let clientePendienteMapa = null;
let clienteSeleccionado = null;
const clientes = @json($clientes);

</script>


<script>
function mostrarClienteEnMapa(cliente, tipo = 'temporal') {

    if (!cliente?.latitud || !cliente?.longitud) return;

    // üî• Si el mapa a√∫n no est√° listo, guardamos el cliente
    if (!mapaGeneralListo) {
        clientePendienteMapa = { cliente, tipo };
        return;
    }

    if (tipo === 'temporal' && marcadorTemporal) {
        marcadorTemporal.setMap(null);
    }

    if (tipo === 'confirmado' && marcadorConfirmado) {
        marcadorConfirmado.setMap(null);
    }

    const iconos = {
        temporal: 'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png',
        confirmado: 'http://maps.google.com/mapfiles/ms/icons/ltblue-dot.png'
    };

    const marker = new google.maps.Marker({
        map: mapaGeneral,
        position: {
            lat: parseFloat(cliente.latitud),
            lng: parseFloat(cliente.longitud)
        },
        icon: {
            url: iconos[tipo],
            scaledSize: new google.maps.Size(40, 40)
        },
        title: cliente.nombre
    });

    mapaGeneral.panTo(marker.getPosition());
    mapaGeneral.setZoom(15);

    if (tipo === 'temporal') marcadorTemporal = marker;
    if (tipo === 'confirmado') marcadorConfirmado = marker;
}
</script>


<script>
document.addEventListener('DOMContentLoaded', function () {

    const buscador = document.getElementById('buscadorCliente');
    if (!buscador) {
        console.warn('buscadorCliente no existe en el DOM');
        return;
    }

    buscador.addEventListener('keyup', function () {

        const q = this.value.toLowerCase();
        const contenedor = document.getElementById('resultadosClientes');
        contenedor.innerHTML = '';

        if (q.length < 2) {
            if (marcadorTemporal) marcadorTemporal.setMap(null);
            return;
        }

        const resultados = clientes
            .filter(c => c.nombre.toLowerCase().includes(q))
            .slice(0, 8);

        resultados.forEach(c => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'list-group-item list-group-item-action';
            btn.dataset.id = c.id;
            btn.innerHTML = `<b>${c.nombre}</b>`;
            contenedor.appendChild(btn);
        });

        const primerCliente = resultados.find(c => c.latitud && c.longitud);
        if (primerCliente) {
            mostrarClienteEnMapa(primerCliente, 'temporal');
        }
    });

});
</script>


<script>
document.addEventListener('click', function (e) {

    const btn = e.target.closest('#resultadosClientes button');
    if (!btn) return;

    clienteSeleccionado = btn.dataset.id;
    document.getElementById('buscadorCliente').value = btn.innerText;
    document.getElementById('resultadosClientes').innerHTML = '';

    if (marcadorTemporal) {
        marcadorTemporal.setMap(null);
        marcadorTemporal = null;
    }

    const cliente = clientes.find(c => String(c.id) === String(clienteSeleccionado));
    if (cliente) {
        mostrarClienteEnMapa(cliente, 'confirmado');
    }
});
</script>

<script>
function initMapaGeneralPedidos() {

    const cont = document.getElementById('mapa-general-pedidos');
    if (!cont) return;

    mapaGeneral = new google.maps.Map(cont, {
        zoom: 13,
        center: { lat: -17.7833, lng: -63.1821 }
    });

    mapaGeneralListo = true;

    
    // Dibujar cola si hab√≠a datos pendientes
    if (colaMotoqueros.length) {
        colaMotoqueros.forEach(actualizarMotoqueroEnMapa);
        colaMotoqueros = [];
    }


    cargarPedidosEnMapaGeneral();

    // üî• Si hab√≠a un cliente pendiente, lo dibujamos ahora
    if (clientePendienteMapa) {
        mostrarClienteEnMapa(
            clientePendienteMapa.cliente,
            clientePendienteMapa.tipo
        );
        clientePendienteMapa = null;
    }

}

function cargarPedidosEnMapaGeneral() {

    marcadoresGeneral.forEach(m => m.setMap(null));
    marcadoresGeneral = [];

    document.querySelectorAll('tbody tr').forEach(row => {

        const lat = row.querySelector('td:nth-child(7)')?.innerText;
        const lng = row.querySelector('td:nth-child(8)')?.innerText;
        const nombreCliente = row.querySelector('td:nth-child(2)')?.innerText;

        if (!lat || !lng || isNaN(lat) || isNaN(lng)) return;

        const marker = new google.maps.Marker({
            map: mapaGeneral,
            position: {
                lat: parseFloat(lat),
                lng: parseFloat(lng)
            },
            icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
            title: nombreCliente || 'Cliente'
        });


        // üîµ Click en fila ‚Üí centrar mapa
        row.addEventListener('click', () => {
            mapaGeneral.panTo(marker.getPosition());
            mapaGeneral.setZoom(15);
        });

        marcadoresGeneral.push(marker);
    });
}
</script>

<script>
function initMaps() {
    document.querySelectorAll('.mapa-por-asignar').forEach(div => {
        cargarMapaPorAsignar(div.dataset.motoquero, div.dataset.ruta || 'A');
    });

    initMapaGeneralPedidos();
}
</script>


<script>

// ==========================
// CREAR PEDIDO R√ÅPIDO
// ==========================
$('#btnCrearPedidoRapido').on('click', function () {

    if (!clienteSeleccionado) {
        alert('Selecciona un cliente');
        return;
    }

    const motoquero = $('#motoqueroSelect').val();
    const ruta = $('#rutaSelect').val();

    if (!motoquero || !ruta) {
        alert('Selecciona motoquero y ruta');
        return;
    }

    $.post("{{ route('admin.pedidos.store') }}", {
        _token: $('meta[name="csrf-token"]').attr('content'),
        cliente_id: clienteSeleccionado,
        motoquero_id: motoquero,
        ruta: ruta
    })
    .done(() => {
        location.reload();
    })
    .fail(err => {
        alert(err.responseJSON?.message || 'Error al crear pedido');
    });
});
</script>






<script>
function cargarMapaPorAsignar(motoqueroId, ruta) {

    const cont = document.getElementById('mapa-por-asignar-' + motoqueroId);
    if (!cont) return;

    // üî• LIMPIAR CONTENEDOR
    cont.innerHTML = '';

    fetch(`/admin/pedidos/mapa-por-asignar?motoquero_id=${motoqueroId}&ruta=${ruta}`)
        .then(r => r.json())
        .then(pedidos => {

            // ‚ùó Sin pedidos
            if (!Array.isArray(pedidos) || pedidos.length === 0) {
                cont.innerHTML = '<small class="text-muted">Sin pedidos en esta ruta</small>';
                return;
            }

            // ‚ùó Filtrar pedidos con lat/lng v√°lidos
            const validos = pedidos.filter(p =>
                p.latitud && p.longitud &&
                !isNaN(p.latitud) && !isNaN(p.longitud)
            );

            if (!validos.length) {
                cont.innerHTML = '<small class="text-danger">Pedidos sin ubicaci√≥n v√°lida</small>';
                return;
            }

            const map = new google.maps.Map(cont, {
                zoom: 13,
                center: {
                    lat: parseFloat(validos[0].latitud),
                    lng: parseFloat(validos[0].longitud)
                }
            });

            // ‚úÖ GUARDAR MAPA
            mapas[motoqueroId] = map;
            ordenMapa[motoqueroId] = [];
            marcadores[motoqueroId] = [];
            modoOrdenMapa[motoqueroId] = false;

            validos.forEach(p => {

                const marker = new google.maps.Marker({
                    map,
                    position: {
                        lat: parseFloat(p.latitud),
                        lng: parseFloat(p.longitud)
                    },
                    label: p.orden ? String(p.orden) : '',
                    title: p.nombre ?? ''
                });

                marker.pedidoId = p.id;
                marker.latlng = {
                    lat: parseFloat(p.latitud),
                    lng: parseFloat(p.longitud)
                };

                marker.addListener('click', () => {
                    if (!modoOrdenMapa[motoqueroId]) return;

                    if (ordenMapa[motoqueroId].includes(marker)) return;

                    ordenMapa[motoqueroId].push(marker);
                    marker.setLabel(String(ordenMapa[motoqueroId].length));

                    dibujarPolilinea(motoqueroId);
                });

                marcadores[motoqueroId].push(marker);
            });



               // üîµ ORDENAR pedidos por campo "orden"
                const pedidosOrdenados = validos
                    .filter(p => p.orden !== null)
                    .sort((a, b) => a.orden - b.orden);

                // üîµ Dibujar polil√≠nea SI YA EXISTE ORDEN
                if (pedidosOrdenados.length > 1) {

                    const path = pedidosOrdenados.map(p =>
                        new google.maps.LatLng(
                            parseFloat(p.latitud),
                            parseFloat(p.longitud)
                        )
                    );

                    polilineas[motoqueroId] = new google.maps.Polyline({
                        path: path,
                        map: map,
                        strokeOpacity: 0.9,
                        strokeWeight: 4
                    });
                }


        })
        .catch(err => {
            console.error('Error cargando mapa:', err);
            cont.innerHTML = '<small class="text-danger">Error cargando mapa</small>';
        });
}

</script>



<script>
function dibujarPolilinea(motoqueroId) {

    if (polilineas[motoqueroId]) {
        polilineas[motoqueroId].setMap(null);
    }

    const path = ordenMapa[motoqueroId].map(m =>
    new google.maps.LatLng(m.latlng.lat, m.latlng.lng)
    );

    polilineas[motoqueroId] = new google.maps.Polyline({
        path,
        map: mapas[motoqueroId],
        strokeOpacity: 0.9,
        strokeWeight: 4
    });
}


document.addEventListener('click', e => {
    const btn = e.target.closest('.btn-ordenar-mapa');
    if (!btn) return;

    const motoqueroId = btn.dataset.motoquero;

    modoOrdenMapa[motoqueroId] = true;
    ordenMapa[motoqueroId] = [];

    if (polilineas[motoqueroId]) {
        polilineas[motoqueroId].setMap(null);
    }

    marcadores[motoqueroId].forEach(m => m.setLabel(''));

    document
        .querySelector(`.btn-guardar-orden-mapa[data-motoquero="${motoqueroId}"]`)
        .disabled = false;

    Swal.fire('Modo orden activado', 'Seleccione los puntos en el mapa', 'info');
});



document.addEventListener('click', e => {
    const btn = e.target.closest('.btn-guardar-orden-mapa');
    if (!btn) return;

    const motoqueroId = btn.dataset.motoquero;

    const orden = ordenMapa[motoqueroId].map((m, i) => ({
        id: m.pedidoId,
        posicion: i + 1
    }));

    fetch("{{ url('/admin/pedidos/ordenar') }}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
        },
        body: JSON.stringify({ orden })
    })
    .then(r => r.json())
    .then(() => {
        Swal.fire('Guardado', 'Orden actualizado correctamente', 'success');
        location.reload();
    });
});

</script>



<script>
document.addEventListener('click', function (e) {

    const btn = e.target.closest('.btn-ruta');
    if (!btn) return;

    // üîë Encontrar el panel del motoquero donde se hizo click
    const motoqueroCard = btn.closest('.motoquero-card');
    if (!motoqueroCard) return;

    const ruta = btn.dataset.ruta;

    // üîπ Activar bot√≥n SOLO en este motoquero
    motoqueroCard.querySelectorAll('.btn-ruta').forEach(b => {
        b.classList.remove('active');
    });
    btn.classList.add('active');

    // üîπ Mostrar SOLO la ruta correspondiente en este motoquero
    motoqueroCard.querySelectorAll('.ruta').forEach(r => {
        r.classList.toggle('active', r.dataset.ruta === ruta);


    });


    const motoqueroId =
        motoqueroCard
            .querySelector('.mapa-por-asignar')
            .dataset.motoquero;

    cargarMapaPorAsignar(motoqueroId, ruta);


});
</script>


<script>
document.addEventListener('click', function (e) {

    const btn = e.target.closest('.btn-emergencia-bar');
    if (!btn) return;

    if (btn.classList.contains('emergencia-activa')) return;

    const pedidoId = btn.dataset.pedidoId;

    fetch(`/admin/pedidos/${pedidoId}/emergencia`, {
        method: 'POST',
        headers: {
            'X-CSRF-TOKEN': document
                .querySelector('meta[name="csrf-token"]').content,
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(r => r.json())
    .then(() => {
        btn.classList.add('emergencia-activa');
        btn.textContent = 'üö® PEDIDO DE EMERGENCIA ACTIVADO';
        btn.disabled = true;
    })
    .catch(err => {
        console.error('Error emergencia:', err);
    });
});
</script>


<script>
function actualizarBotonEmergencia() {

    // Quitar todos los botones existentes
    document.querySelectorAll('.btn-emergencia-bar').forEach(b => b.remove());

    // Recorremos cada lista de ASIGNADOS
    document.querySelectorAll('.lista-asignado').forEach(lista => {

        const primerPedido = lista.querySelector('.pedido-item');

        if (!primerPedido) return;

        const pedidoId = primerPedido.dataset.id;

        const boton = document.createElement('button');
        boton.className = 'btn-emergencia-bar';
        boton.dataset.pedidoId = pedidoId;
        boton.textContent = 'üö® PEDIDO DE EMERGENCIA';

        primerPedido.prepend(boton);
    });
}
</script>



<script>
document.addEventListener('click', function (e) {

    const btn = e.target.closest('.btn-recibo');
    if (!btn) return;

    btn.classList.remove('btn-primary');
    btn.classList.add('btn-success');
    btn.innerHTML = '<i class="fab fa-whatsapp"></i> Recibo enviado';

});
</script>


<script>
function refrescarPanelMotoquero(motoqueroId) {

    const panel = document.getElementById('panel-motoquero-' + motoqueroId);
    if (!panel) {
        console.warn('Panel no encontrado para motoquero:', motoqueroId);
        return;
    }

    // üîë conservar fecha actual
    const params = new URLSearchParams(window.location.search);
    const fecha = params.get('fecha') || '';

    const url = fecha
        ? window.location.pathname + '?fecha=' + fecha
        : window.location.pathname;

    fetch(url, {
        method: 'GET',
        credentials: 'same-origin', // üî• CLAVE
        cache: 'no-store',          // üî• CLAVE
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(res => res.text())
    .then(html => {

        const temp = document.createElement('div');
        temp.innerHTML = html;

        const nuevoPanel = temp.querySelector('#panel-motoquero-' + motoqueroId);
        if (!nuevoPanel) {
            console.error('No se encontr√≥ el panel en la respuesta HTML');
            return;
        }

        panel.innerHTML = nuevoPanel.innerHTML;
        console.log('Panel actualizado correctamente:', motoqueroId);
    })
    .catch(err => {
        console.error('Error al refrescar panel:', err);
    });
}
</script>


<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar SortableJS en listas por asignar y asignado
    document.querySelectorAll('.lista-por-asignar, .lista-asignado').forEach(function(el){

        new Sortable(el, {
            group: {
                name: 'solo-orden',
                pull: false,
                put: false
            },
            animation: 150,
            ghostClass: 'dragging',

            onMove: function (evt) {

                // üî• Si intenta moverse a otra lista ‚Üí cancelar
                if (evt.from !== evt.to) {
                    return false;
                }

            },

            onEnd: function(evt){

                // üõë Seguridad extra
                if (evt.from !== evt.to) {
                    evt.from.insertBefore(evt.item, evt.from.children[evt.oldIndex]);
                    return;
                }

                let lista = evt.to;

                lista.querySelectorAll('.pedido-item').forEach((item,index)=>{
                    item.querySelector('b').textContent = '#' + (index + 1);
                });

                let orden = [];
                lista.querySelectorAll('.pedido-item').forEach((item,index)=>{
                    orden.push({id: item.dataset.id, posicion: index + 1});
                });

                fetch("{{ url('/admin/pedidos/ordenar') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify({orden: orden})
                });

                actualizarBotonEmergencia();

                const motoqueroId = lista.dataset.motoquero;
                const ruta = lista.dataset.ruta;

                if (mapas[motoqueroId]) {
                    cargarMapaPorAsignar(motoqueroId, ruta);
                }
            }
        });

    });
    

    actualizarBotonEmergencia();

});

    // === BOT√ìN: "Por asignar ‚Üí Asignado" dentro de POR ASIGNAR (admin)
        $(document).on('click', '.btn_asignar_todos', function () {

        let motoquero_id = $(this).data('motoquero');
        let ruta = $(this).data('ruta'); // üî• CLAVE
        let _token = $('meta[name="csrf-token"]').attr('content');


        if (!ruta) {
        Swal.fire('Error', 'Ruta no definida', 'error');
        return;
        }


        $.ajax({
            url: "{{ url('/admin/pedidos/asignar-motoquero-multiple') }}",
            type: "POST",
            data: { motoquero_id: motoquero_id, ruta: ruta, _token: _token },
            success: function () {
             Swal.fire({
                icon: 'success',
                title: 'Pedidos de ruta ${ruta} asignados',
                timer: 900,
                showConfirmButton: false
                }).then(() => location.reload());
            },
                error: function (xhr) {
             Swal.fire('Error', 'No se pudo asignar: ' + (xhr.responseText || ''), 'error');
            }
        });
    });



////////
document.addEventListener('DOMContentLoaded', function() {

    // ========================
    // Variables globales
    // ========================
    let motoqueroSeleccionado = null;
    const modalReporteEl = document.getElementById('modalReporte');
    let modalReporteInstance = null;

    // ========================
    // Inicializar modal (Bootstrap 5)
    // ========================
    if(modalReporteEl) {
        modalReporteInstance = new bootstrap.Modal(modalReporteEl, {
            keyboard: true,   // permite ESC
            backdrop: true    // permite clic afuera
        });
    }

    // ========================
    // Abrir modal y cargar reporte
    // ========================
    document.querySelectorAll('.abrirReporte').forEach(button => {
        button.addEventListener('click', function() {
            motoqueroSeleccionado = this.dataset.motoquero;
            if(modalReporteInstance) {
                modalReporteInstance.show();
                cargarReporte();
            }
        });
    });

    // ========================
    // Cambiar fecha dentro del modal
    // ========================
    document.addEventListener('change', function(e) {
        if(e.target && e.target.id === 'fecha_reporte') {
            cargarReporte();
        }
    });

    // ========================
    // Funci√≥n para cargar reporte v√≠a AJAX
    // ========================
    function cargarReporte() {
        const fechaGlobal = document.getElementById('fecha_reporte')?.value || document.getElementById('fecha')?.value || '';
        const _token = document.querySelector('meta[name="csrf-token"]').content;

        if(!motoqueroSeleccionado) return;

        const contenidoEl = document.getElementById('contenidoReporte');
        if(!contenidoEl) return;

        contenidoEl.innerHTML = '<p class="text-center">Cargando...</p>';

        fetch("{{ route('admin.pedidos.reporte_motoquero') }}?motoquero_id=" + motoqueroSeleccionado + "&fecha=" + fechaGlobal, {
            method: 'GET',
            headers: {
                'X-CSRF-TOKEN': _token,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => contenidoEl.innerHTML = html)
        .catch(err => contenidoEl.innerHTML = '<p class="text-danger">Error al cargar datos.<br>' + err + '</p>');
    }

    // ========================
    // Delegaci√≥n de eventos para botones din√°micos
    // ========================
    document.addEventListener('click', function(e) {
        // Ejemplo: bot√≥n dentro del reporte din√°mico
        if(e.target && e.target.classList.contains('btn-dinamico')) {
            e.preventDefault();
            // Aqu√≠ colocas la acci√≥n que necesites
            console.log('Bot√≥n din√°mico clickeado:', e.target);
        }
    });

    // ========================
    // Cerrar modal con botones de cierre (X o Footer)
    // ========================
    document.querySelectorAll('[data-bs-dismiss="modal"]').forEach(btn => {
        btn.addEventListener('click', function() {
            if(modalReporteInstance) modalReporteInstance.hide();
        });
    });

});

</script>





{{-- ======================================================= --}}
{{-- JS: Registrar pedido desde WhatsApp --}}
{{-- ======================================================= --}}

<script>
document.addEventListener('click', function (e) {

    /* ===============================
       CENTRAR MAPA AL HACER CLICK
       =============================== */
    const cardMapa = e.target.closest('.whatsapp-contact');
    if (cardMapa && !e.target.classList.contains('btn-registrar-pedido')) {
        const lat = parseFloat(cardMapa.dataset.lat);
        const lng = parseFloat(cardMapa.dataset.lng);

        if (lat && lng && !isNaN(lat) && !isNaN(lng)) {
            mapaGeneralPedidos.setCenter({ lat, lng });
            mapaGeneralPedidos.setZoom(17);
        }
    }

    /* ===============================
       REGISTRAR PEDIDO
       =============================== */
    if (!e.target.classList.contains('btn-registrar-pedido')) return;

    const btn  = e.target;
    const card = btn.closest('.whatsapp-contact');

    const motoquero = card.querySelector('.selector-motoquero').value;
    const ruta      = card.querySelector('.selector-ruta').value;

    if (!motoquero || !ruta) {
        Swal.fire({
            icon: 'warning',
            title: 'Faltan datos',
            text: 'Seleccione motoquero y ruta antes de registrar el pedido'
        });
        return;
    }

    // Cargamos datos en el formulario oculto
    document.getElementById('wp_nombre').value    = btn.dataset.nombre;
    document.getElementById('wp_celular').value   = btn.dataset.celular;
    document.getElementById('wp_motoquero').value = motoquero;
    document.getElementById('wp_ruta').value      = ruta;

    // Enviamos como formulario normal
    document.getElementById('formPedidoWhatsapp').submit();
});
</script>





<script>
let llamadaActual = null;
let modalLlamada = null;

// ==============================
// Inicializar modal (Bootstrap 5)
// ==============================
document.addEventListener("DOMContentLoaded", () => {
    const modalEl = document.getElementById("modalLlamada");
    if (modalEl) {
        modalLlamada = new bootstrap.Modal(modalEl, {
            backdrop: true,
            keyboard: true
        });
    }
});

// ==============================
// POLLING seguro cada 5 segundos
// ==============================
setInterval(() => {
    fetch("{{ route('llamadas.poll') }}", {
        headers: {
            'Accept': 'application/json'
        },
        redirect: 'manual'
    })
    .then(res => {
        // ‚ùå NO seguir redirecciones
        if (res.status === 302) return null;
        if (res.status === 204) return null;
        if (res.status === 401) return null;

        return res.json();
    })
    .then(llamadas => {
        if (!Array.isArray(llamadas)) return;
        if (llamadas.length === 0) return;

        mostrarModal(llamadas[0]);
    })
    .catch(() => {});
}, 5000);


// ==============================
// Cerrar modal
// ==============================
function cerrarModalLlamada() {
    if (!modalLlamada || !llamadaActual) return;

    const audio = document.getElementById("sonidoAlerta");
    if (audio) {
        audio.pause();
        audio.currentTime = 0;
    }

    if (navigator.vibrate) navigator.vibrate(0);

    fetch("/admin/llamadas/" + llamadaActual.id + "/cerrar", {
        method: "POST",
        headers: {
            "X-CSRF-TOKEN": "{{ csrf_token() }}"
        }
    })
    .finally(() => {
        modalLlamada.hide();
        llamadaActual = null;
    });
}


// ==============================
// Mostrar modal
// ==============================
function mostrarModal(data) {

    // Evitar duplicados
    if (llamadaActual && llamadaActual.id === data.id) return;

    llamadaActual = data;

    const cont = document.getElementById("contenidoLlamada");
    if (!cont) return;

    cont.innerHTML = `
        <p><strong>Cliente:</strong> ${data.nombre_cliente}</p>
        <p><strong>Celular:</strong> ${data.celular_cliente}</p>
        <p><strong>Descripci√≥n:</strong> ${data.cliente?.direccion ?? 'Sin descripci√≥n'}</p>
        <p><strong>Motoquero:</strong> ${data.motoquero_id}, ${data.nombre_motoquero}</p>
        <p class="text-danger fw-bold">
            El distribuidor solicita contactar al cliente.
        </p>
    `;

    // üîä Sonido
    const audio = document.getElementById("sonidoAlerta");
    if (audio) {
        audio.currentTime = 0;
        audio.play().catch(() => {});
    }

    // üì≥ Vibraci√≥n
    if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200]);
    }

    modalLlamada.show();

    // Acci√≥n bot√≥n aceptar
    const btnAceptar = document.getElementById("btnAceptarLlamada");
    if (btnAceptar) {
        btnAceptar.onclick = () => {
            atenderLlamada(data.id, data.celular_cliente);
        };
    }
}


// ==============================
// Atender llamada
// ==============================
function atenderLlamada(id, celular) {

    fetch("/admin/llamadas/" + id + "/atender", {
        method: "POST",
        headers: {
            "X-CSRF-TOKEN": "{{ csrf_token() }}"
        }
    })
    .finally(() => {

        const audio = document.getElementById("sonidoAlerta");
        if (audio) {
            audio.pause();
            audio.currentTime = 0;
        }

        if (navigator.vibrate) navigator.vibrate(0);

        if (modalLlamada) modalLlamada.hide();

        // WhatsApp
        const url =
            "https://wa.me/" +
            celular +
            "?text=" +
            encodeURIComponent("El distribuidor ya lleg√≥ a su ubicaci√≥n.");

        window.open(url, "_blank");

        llamadaActual = null;
    });
}
</script>




<script>
let avisoActual = null;
let modalAviso = null;

// Inicializar modal
document.addEventListener("DOMContentLoaded", () => {
    modalAviso = new bootstrap.Modal(
        document.getElementById("modalAvisoNavegacion"),
        { backdrop: true, keyboard: true }
    );
});

// üîÑ Poll cada 5 segundos (SEGURO)
setInterval(() => {
    fetch("{{ route('avisos.navegacion.poll') }}", {
        headers: {
            'Accept': 'application/json'
        },
        redirect: 'manual'
    })
    .then(res => {
        // ‚ùå nunca seguir redirects
        if (res.status === 302) return null;
        if (res.status === 204) return null;
        if (res.status === 401) return null;

        return res.json();
    })
    .then(aviso => {
        if (!aviso || !aviso.id) return;
        mostrarAviso(aviso);
    })
    .catch(() => {});
}, 5000);


function cerrarModalAviso() {
    if (!modalAviso || !avisoActual) return;

    detenerSonido();

    fetch("/admin/avisos-navegacion/" + avisoActual.id + "/cerrar", {
        method: "POST",
        headers: {
            "X-CSRF-TOKEN": "{{ csrf_token() }}",
            "Accept": "application/json"
        }
    }).finally(() => {
        modalAviso.hide();
        avisoActual = null;
    });
}


function mostrarAviso(data) {

    if (avisoActual && avisoActual.id === data.id) return;

    avisoActual = data;

    document.getElementById("contenidoAvisoNavegacion").innerHTML = `
        <p><strong>Cliente:</strong> ${data.cliente}</p>
        <p><strong>Celular:</strong> ${data.celular}</p>
        <p><strong>Descripci√≥n:</strong> ${data.pedido?.cliente?.direccion ?? 'Sin descripci√≥n'}</p>
        <p><strong>Motoquero ID:</strong> ${data.motoquero_id}</p>
        <p class="text-primary fw-bold">
            El distribuidor inici√≥ la navegaci√≥n hacia la ubicaci√≥n del cliente.
        </p>
    `;

    reproducirSonido();
    modalAviso.show();

    if (avisoActual.motoquero_id) {
        refrescarPanelMotoquero(avisoActual.motoquero_id);
    }

    document.getElementById("btnAvisarCliente").onclick = () => {
        atenderAviso(data.id, data.celular);
    };
}


function atenderAviso(id, celular) {

    fetch("/admin/avisos-navegacion/" + id + "/atender", {
        method: "POST",
        headers: {
            "X-CSRF-TOKEN": "{{ csrf_token() }}",
            "Accept": "application/json"
        }
    })
    .then(() => {
        detenerSonido();
        modalAviso.hide();
        avisoActual = null;

        const url =
            "https://wa.me/" +
            celular +
            "?text=" +
            encodeURIComponent(
                "El distribuidor est√° en camino a su ubicaci√≥n. Por favor mant√©ngase atento."
            );

        window.open(url, "_blank");
    });
}


function reproducirSonido() {
    const audio = document.getElementById("sonidoEnCamino");
    audio.currentTime = 0;
    audio.play().catch(() => {});
    if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
}

function detenerSonido() {
    const audio = document.getElementById("sonidoEnCamino");
    audio.pause();
    audio.currentTime = 0;
    if (navigator.vibrate) navigator.vibrate(0);
}

</script>



<script>
/**
 * ================================
 * TRACKING DE MOTOQUEROS (ADMIN)
 * ================================
 * - Usa SOLO motoquero.id
 * - No depende de usuario
 * - Dibuja recorrido
 * - Actualiza cada 5 segundos
 */

const marcadoresMotoqueros = {};
const recorridosMotoqueros = {};
const MAX_PUNTOS = 50; // l√≠mite de puntos del recorrido (performance)
let colaMotoqueros = []; // temporal

// üîÑ Polling cada 5 segundos
setInterval(() => {
    fetch('/admin/pedidos/motoqueros/ubicaciones', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(r => {
        if (!r.ok) throw new Error('Error al obtener ubicaciones');
        return r.json();
    })
    .then(data => {
        if (!Array.isArray(data)) return;

        if (!mapaGeneralListo) {
            colaMotoqueros = data;
        } else {
            data.forEach(actualizarMotoqueroEnMapa);
        }

    })
    .catch(err => {
        console.error('Error tracking motoqueros:', err);
    });
}, 5000);


/**
 * =================================
 * Actualizar / crear marcador
 * =================================
 */
function actualizarMotoqueroEnMapa(m) {

    // üõ°Ô∏è Validaciones fuertes
    if (
        !m ||
        !m.motoquero_id ||
        m.latitud === null ||
        m.longitud === null
    ) return;

    if (!mapaGeneralListo || !window.google || !google.maps) return;

    // ‚úÖ LatLng REAL (no objeto plano)
    const pos = new google.maps.LatLng(
        parseFloat(m.latitud),
        parseFloat(m.longitud)
    );

    // üöö Icono camioncito
    const icono = {
        url: '/img/camioncito.png',
        scaledSize: new google.maps.Size(36, 36)
    };

    // üÜï Crear marcador si no existe
    if (!marcadoresMotoqueros[m.motoquero_id]) {

        marcadoresMotoqueros[m.motoquero_id] = new google.maps.Marker({
            map: mapaGeneral,
            position: pos, // ‚úÖ OK
            icon: icono,
            title: `DIS: ${m.motoquero_id} | √ölt. act: ${formatearFecha(m.registrado_en)}`
        });

        // üìç Crear recorrido (Polyline SOLO acepta LatLng)
        recorridosMotoqueros[m.motoquero_id] = new google.maps.Polyline({
            map: mapaGeneral,
            path: [pos], // ‚úÖ OK
            strokeOpacity: 0.9,
            strokeWeight: 4
        });

    } else {

        // üîÑ Actualizar posici√≥n
        marcadoresMotoqueros[m.motoquero_id].setPosition(pos);
        marcadoresMotoqueros[m.motoquero_id].setTitle(
            `DIS: ${m.motoquero_id} | √ölt. act: ${formatearFecha(m.registrado_en)}`
        );

        // ‚ûï Agregar punto al recorrido
        const path = recorridosMotoqueros[m.motoquero_id].getPath();
        path.push(pos); // ‚úÖ SOLO LatLng

        // üßπ Limitar cantidad de puntos
        if (path.getLength() > MAX_PUNTOS) {
            path.removeAt(0);
        }
    }
}


/**
 * ================================
 * Formatear fecha amigable
 * ================================
 */
function formatearFecha(fecha) {
    if (!fecha) return 'N/D';
    const d = new Date(fecha);
    return d.toLocaleTimeString('es-BO', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
}
</script>


<script>
let modalEditarInstance = null;

// ===============================
// Inicializar modal UNA VEZ
// ===============================
document.addEventListener('DOMContentLoaded', () => {

    const modalEl = document.getElementById('modalEditarPedido');
    if (!modalEl) {
        console.error('‚ùå Modal editar no encontrado');
        return;
    }

    modalEditarInstance = new bootstrap.Modal(modalEl, {
        backdrop: true,
        keyboard: true
    });
});

// ===============================
// Abrir modal (FUNCI√ìN GLOBAL)
// ===============================
function abrirModalEditar() {
    if (!modalEditarInstance) return;
    modalEditarInstance.show();
}

// ===============================
// Cerrar modal (FUNCI√ìN GLOBAL)
// ===============================
function cerrarModalEditar() {
    if (!modalEditarInstance) return;
    modalEditarInstance.hide();
}
</script>


<script>
document.addEventListener('click', function (e) {

    const btn = e.target.closest('.btn-editar-pedido');
    if (!btn) return;

    // üõë CLAVES ABSOLUTAS
    e.preventDefault();
    e.stopPropagation();

    const pedidoId = btn.dataset.pedidoId;
    if (!pedidoId) return;

    fetch(`/admin/pedidos/${pedidoId}/editar`)
        .then(res => res.json())
        .then(data => {

            if (!['Por asignar', 'Asignado'].includes(data.estado)) {
                Swal.fire(
                    'No permitido',
                    'Este pedido no se puede editar',
                    'warning'
                );
                return;
            }

            // Cargar datos
            document.getElementById('edit_pedido_id').value = data.id;
            document.getElementById('edit_cliente').value = data.cliente;
            document.getElementById('edit_motoquero').value = data.motoquero_id ?? '';
            document.getElementById('edit_ruta').value = data.ruta ?? 'A';
            document.getElementById('edit_promo_activa').checked = data.promo_activa == 1;

            const link = document.getElementById('edit_ubicacion');
            if (data.ubicacion) {
                link.href = data.ubicacion;
                link.textContent = 'Ver ubicaci√≥n';
            } else {
                link.href = '#';
                link.textContent = 'No registrada';
            }

            abrirModalEditar();
        })
        .catch(() => {
            Swal.fire('Error', 'No se pudo cargar el pedido', 'error');
        });

});
</script>


<script>
document.addEventListener('DOMContentLoaded', function () {

    const btnGuardar = document.getElementById('btnGuardarEdicion');

    if (!btnGuardar) {
        console.error('‚ùå btnGuardarEdicion NO existe en el DOM');
        return;
    }

    btnGuardar.addEventListener('click', function () {

        const pedidoId = document.getElementById('edit_pedido_id')?.value;
        if (!pedidoId) {
            console.warn('‚ö†Ô∏è No hay pedido_id');
            return;
        }

        const data = {
            pedido_id: pedidoId,
            promo_activa: document.getElementById('edit_promo_activa').checked ? 1 : 0,
            motoquero_id: document.getElementById('edit_motoquero').value,
            ruta: document.getElementById('edit_ruta').value,
            _token: '{{ csrf_token() }}'
        };

        fetch('/admin/pedidos/actualizar-edicion', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(data)
        })
        .then(res => {
            if (!res.ok) throw new Error('Error HTTP');
            return res.json();
        })
        .then(() => {
            cerrarModalEditar();

            Swal.fire({
                icon: 'success',
                title: 'Pedido actualizado',
                timer: 900,
                showConfirmButton: false
            }).then(() => location.reload());
        })
        .catch(err => {
            console.error(err);
            Swal.fire('Error', 'No se pudo guardar el pedido', 'error');
        });

    });

});
</script>

<script>
document.addEventListener('click', function (e) {

    const boton = e.target.closest('.btn-avisar');
    if (!boton) return;

    let pedidoId = boton.dataset.id;
    let tipo = boton.dataset.tipo;

    fetch(`/admin/pedidos/${pedidoId}/avisar`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-TOKEN': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ tipo: tipo })
    })
    .then(response => response.json())
    .then(data => {

        if(data.success){

            boton.disabled = true;
            boton.innerText = "‚úî Enviado";

            setTimeout(() => {
                boton.disabled = false;
                boton.innerText = tipo === 'ya_sale'
                    ? "üöÄ Ya Sale"
                    : "üìû No Contesta";
            }, 3000);

        } else {
            alert('Error al enviar aviso');
        }

    })
    .catch(error => {
        alert('Error de conexi√≥n');
    });

});
</script>

<!-- Modal de llamada de llegada-->
<div class="modal fade" id="modalLlamada" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-warning">
      <div class="modal-header bg-warning">
        <h5 class="modal-title">
            üö® Nueva Solicitud de Llamada
        </h5>
        <button type="button" class="btn-close" onclick="cerrarModalLlamada()"></button>
      </div>

      <div class="modal-body" id="contenidoLlamada">
        <!-- Aqu√≠ se cargar√° la info -->
      </div>

      <div class="modal-footer">
        <button id="btnAceptarLlamada" class="btn btn-primary">
            Aceptar y Contactar
        </button>

        <!-- CORRECTO EN BS5 -->
        <button type="button" class="btn btn-secondary" onclick="cerrarModalLlamada()">
            Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

<audio id="sonidoAlerta" src="/sounds/alertallegada.mp3" preload="auto"></audio>



<!-- Modal de llamada en camino -->
<div class="modal fade" id="modalAvisoNavegacion" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-primary">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
            üöö Aviso de Navegaci√≥n
        </h5>
        <button type="button" class="btn-close" onclick="cerrarModalAviso()"></button>
      </div>

      <div class="modal-body" id="contenidoAvisoNavegacion"></div>

      <div class="modal-footer">
        <button id="btnAvisarCliente" class="btn btn-success">Aceptar y Avisar</button>

        <button type="button" class="btn btn-secondary" onclick="cerrarModalAviso()">
            Cerrar
        </button>
      </div>
    </div>
  </div>
</div>
<audio id="sonidoEnCamino" src="/sounds/alertaencamino.mp3" preload="auto"></audio>


<!-- Modal Reporte de Ventas (Bootstrap 5) -->
<div class="modal fade" id="modalReporte" tabindex="-1" aria-labelledby="modalReporteLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      
      <!-- Header -->
      <div class="modal-header">
        <h5 class="modal-title" id="modalReporteLabel">Reporte de Ventas - Motoquero</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      
      <!-- Body -->
      <div class="modal-body">
        <div class="mb-3 d-flex align-items-center" style="gap: 10px;">
          <label for="fecha_reporte" class="form-label mb-0"><b>Fecha:</b></label>
          <input type="date" id="fecha_reporte" class="form-control" value="{{ now()->format('Y-m-d') }}">
        </div>

        <div id="contenidoReporte">
          <p class="text-center">Seleccione un motoquero y una fecha para cargar el reporte.</p>
        </div>
      </div>
      
      <!-- Footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>

    </div>
  </div>
</div>



<!-- MODAL EDITAR PEDIDO -->
<div class="modal fade" id="modalEditarPedido" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Editar pedido</h5>
                <!-- ‚ùå SIN data-bs-dismiss -->
                <button type="button" class="btn-close" onclick="cerrarModalEditar()"></button>
            </div>

            <div class="modal-body">

                <input type="hidden" id="edit_pedido_id">

                <!-- DATOS DEL CLIENTE -->
                <div class="mb-3">
                    <label class="form-label">Cliente</label>
                    <input type="text" class="form-control" id="edit_cliente" readonly>
                </div>

                <div class="mb-3">
                    <label class="form-label">Ubicaci√≥n</label>
                    <a href="#" target="_blank" id="edit_ubicacion">Ver ubicaci√≥n</a>
                </div>

                <hr>

                <!-- PROMOCI√ìN -->
                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" id="edit_promo_activa">
                    <label class="form-check-label" for="edit_promo_activa">
                        Cliente con promoci√≥n activa
                    </label>
                </div>

                <!-- DISTRIBUIDOR -->
                <div class="mb-3">
                    <label class="form-label">Distribuidor</label>
                    <select class="form-select" id="edit_motoquero">
                        @foreach($motoqueros as $m)
                            <option value="{{ $m->id }}">
                                {{ $m->apellidos }} {{ $m->nombres }}
                            </option>
                        @endforeach
                    </select>
                </div>

                <!-- RUTA -->
                <div class="mb-3">
                    <label class="form-label">Ruta</label>
                    <select class="form-select" id="edit_ruta">
                        <option value="A">Ruta A</option>
                        <option value="B">Ruta B</option>
                        <option value="C">Ruta C</option>
                        <option value="D">Ruta D</option>
                    </select>
                </div>

            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModalEditar()">Cancelar</button>
                <button class="btn btn-primary" id="btnGuardarEdicion">
                    Guardar cambios
                </button>
            </div>

        </div>
    </div>
</div>

@stop